{{extend "forums_layout.html"}}

{{block forum_nav}}
    <ul class="breadcrumb">
      <li>
        <a href="{{=url_for('plugs.forums.views.ForumView.list')}}" class="home" title="首页">论坛首页</a> <span class="divider">/</span>
      </li>
      <li class="active">
        <a href="{{=url_for('plugs.forums.views.ForumView.forum_index', id=forum.id)}}">{{=forum.name}}</a>
      </li>
    </ul>
    
    <form class="form-inline pull-left" action="" method="GET">
        <input type="text" class="input-large" name="term" value="{{=term}}">
        <label class="radio">
            <input type="radio" name="type" id="optionsRadios1" value="1" {{if type=="1":}}checked=""{{pass}}>
            标题
        </label>
        <label class="radio">
            <input type="radio" name="type" id="optionsRadios2" value="2" {{if type=="2":}}checked=""{{pass}}>
            作者
        </label>
        <button type="submit" class="btn btn-primary">查找</button>
    </form>
    
    <div class="pull-right" style="margin-bottom:16px;">
        {{if request.user:}}
        <a class="btn btn-success" href="{{=url_for('plugs.forums.views.ForumView.new_topic', id=forum.id)}}">新主题</a>
        {{else:}}
        <font color="red">你还没有登录，无法发表新主题！</font>
        {{pass}}
    </div>
{{end}}

{{block content_main}}
{{use "jquery"}}
{{use "jqutils", hoverIntent=True}}

<script type="text/html" id="topicTemplate">
    <tr>
        <td align="left" class="first">${subject}</td>
        <td align="left"><cite>${posted_by}</cite><em>${created_on}</em></td>
        <td align="center"><b>${num_replies}</b>/<b>${num_views}</b></td>
        <td align="left"><cite>${last_post_user}</cite><em>${last_reply_on}</em></td>
    </tr>
</script>
<table border="0" width="100%" class="forum">
    <thead>
        <tr class="head">
            <td align="left" class="first">
            <span>筛选：</span>
                <div class="hover-menu">
                <cite>{{=filter_name}}<b class="caret"></b></cite>
                <ul class="items">
                    <li><a href="?filter=all">全部主题</a></li>
                    <li><a href="?filter=essence">精华</a></li>
                    <li><a href="?filter=sticky">顶置</a></li>
                </ul>
                </div>
            </td>
            <td width="100px">作者</td>
            <td width="100px" align="center">文章/浏览</td>
            <td width="150px">最后回复</td>
        </tr>
    </thead>
    <tbody id="forum_table">
    </tbody>
</table>
<div id="paginate"></div>
{{include "inc_paginate.html"}}
{{use "history"}}
<script type="text/javascript">
    
    var load_topics = function(page){
        page = page || 1;
        
        var History = window.History;

        //remember history
        History.pushState('', '', $.query_string.set('page', page, true).toString());
        
        $.ajax({
            type: "POST",
            dataType: 'json',
            data: {data:'', page:page},
            url: "{{=request.path}}"+$.query_string.toString(),
            success: function(data){
                var forum = $('#forum_table')
                forum.empty();
                $.each(data.rows, function(index, value){
                    var topic = template($('#topicTemplate').html(), value).appendTo(forum);
                });
                create_pagination('#paginate', data.total, {{=settings.get_var('PARA/FORUM_INDEX_NUMS')}}, page, load_topics);
            }
        });
    }
    
    $(function(){
        load_topics({{=page}});
        $('.hover-menu').hover_menu();
        
        var History = window.History;

        //bind statechange event
        $(window).bind('statechange',function(){
            var
                State = History.getState(),
                url = State.url;
            var page = $.query_string.load(url).get('page');
            console.log(url);
            load_topics(page);
        });
        
        
    });
</script>
{{end}}
